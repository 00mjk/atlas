# MPDATA Shallow Water #

This program computes the shallow water equations on a sphere,
using the edge-based unstructured mesh discretisation with the
MPDATA algorithm.

The discretisation is based on the article
"An edge-based unstructured mesh discretisation in geospherical framework",
Szmelter, Smolarkiewicz, JCP (2010)

The shallow water equations are initialised with the Rossby-Haurwitz initial
condition, and simulated for 15 days

## Notes ##
The main program can be found in src/shallow_water.F90. 
The actual solver routines can be found in the src/shallow_water_module.F90

All other files, especially in the src/mesh, and src/io directory are
really the underlying data-structure, which is under development and 
can change at any moment.
It is not necessary to understand the underlying data-structure to follow
the workings of the solver.

## TODO ##
- Implement parallelisation in the underlying datastructure

## Installation ##
- Copy the meshvol.d file generated from Joanna Szmelter's DualMesh.f90 program,
  provided elsewhere, to the data directory. Note: this is the file generated by
  a early version without the experimental partitioning algorithm.
- Compile and run the shallow_water program

```
export FC=gfortran
make clean shallow_water
./shallow_water
```

Optionally, also export the GRIB_API_DIR before compiling, if available, for grib output

## Inspecting results ##
In the data directory you will find various output files:

- results.d, giving the results for depth, and wind velocity at the end of 15 days, in the same format of Joanna Szmelter's coding.
- fields00.msh ... fields15.msh : Gmsh field files containing depth and momentum for every day
- depth00.grib ... depth15.grib: Grib field files containing the depth for every day

#### Gmsh Visualisation ###
- Download the free open source software Gmsh (http://geuz.org/gmsh/)
- Convert the mesh.d file, generated by Joanna Szmelter's PrimaryGrid.f90 program to mesh_latlon.msh

``` 
python primary_mesh_to_gmsh.py path/to/mesh.d
```

- View the output in Gmsh:

```
gmsh mesh_latlon.msh data/fields*.msh &
```

- Right-click on any field in the Gmsh viewer, and select "Combine Time Steps > By View Name"
